version: "2.1"
services:
  # Other services
  db-migrations:
    build: services/db-migrations
    command: ./setup-photo-garden.sh
    depends_on:
      - db
    links:
      - db

  queue:
    image: nats-streaming
    command: -m 8222 -store file -dir datastore
    ports:
      - "4222:4222"
      - "8222:8222"

  db:
    build: services/db
    ports:
      - "5432:5432"

  gateway:
    extends:
      file: common-service.yml
      service: base-service
    build:
      args:
        APP_NAME: gateway
    environment:
      - PHOTO_GARDEN_PROVIDERS_GOOGLE_DRIVE_CLIENT_ID
      - PHOTO_GARDEN_PROVIDERS_GOOGLE_DRIVE_CLIENT_SECRET
      - PHOTO_GARDEN_PROVIDERS_DROPBOX_CLIENT_ID
      - PHOTO_GARDEN_PROVIDERS_INSTAGRAM_CLIENT_ID
      - PHOTO_GARDEN_PROVIDERS_INSTAGRAM_CLIENT_SECRET
    depends_on:
      - queue
      - db
    links:
      - queue
      - db
    ports:
      - "3000:3000"

  photo-server:
    build: services/photo-server
    volumes:
      - photo-storage:/usr/share/nginx/html/
    ports:
      - "3010:80"

  be-dropbox:
    extends:
      file: common-service.yml
      service: base-service
    build:
      args:
        APP_NAME: be-dropbox
    depends_on:
      - queue
      - db
    links:
      - queue
      - db

  be-process-exif:
    extends:
      file: common-service.yml
      service: base-service
    build:
      args:
        APP_NAME: be-process-exif
    volumes:
      - photo-storage:/usr/src/photos
    depends_on:
      - queue
      - db
    links:
      - queue
      - db

  be-download-user-photo-google-drive:
    extends:
      file: common-service.yml
      service: base-service
    build:
      args:
        APP_NAME: be-download-user-photo-google-drive
    volumes:
      - photo-storage:/usr/src/photos
    depends_on:
      - queue
    links:
      - queue

  be-download-user-photo:
    extends:
      file: common-service.yml
      service: base-service
    build:
      args:
        APP_NAME: be-download-user-photo
    volumes:
      - photo-storage:/usr/src/photos
    depends_on:
      - queue
    links:
      - queue

  be-instagram:
    extends:
      file: common-service.yml
      service: base-service
    build:
      args:
        APP_NAME: be-instagram
    volumes:
      - photo-storage:/usr/src/photos
    depends_on:
      - queue
      - db
    links:
      - queue
      - db

  be-normalize-user-photo-google-drive:
    extends:
      file: common-service.yml
      service: base-service
    build:
      args:
        APP_NAME: be-normalize-user-photo-google-drive
    depends_on:
      - queue
    links:
      - queue

  api-photos:
    extends:
      file: common-service.yml
      service: base-service
    build:
      args:
        APP_NAME: api-photos
    ports:
      - "3002:3000"
    depends_on:
      - db
    links:
      - db

  web-frontend:
    extends:
      file: common-service.yml
      service: base-service
    build:
      args:
        APP_NAME: web-frontend
    ports:
      - "3001:1234"

volumes:
  photo-storage:
